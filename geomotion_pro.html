<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>GeoMotion PRO</title>

    <!-- PWA Meta Tags -->
    <meta name="theme-color" content="#0B0F19">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="apple-touch-icon" href="https://cdn-icons-png.flaticon.com/512/2983/2983696.png">
    
    <!-- Link ke Manifest -->
    <link rel="manifest" href="./manifest.json">
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Leaflet CSS (Peta) -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&family=Inter:wght@300;400;600;800&display=swap" rel="stylesheet">

    <!-- Chart.js (Grafik) -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                        mono: ['JetBrains Mono', 'monospace'],
                    },
                    colors: {
                        dark: '#0B0F19',
                        panel: '#151b2b',
                        accent: '#3b82f6',
                        accentGlow: 'rgba(59, 130, 246, 0.5)',
                        success: '#10b981',
                    },
                    animation: {
                        'pulse-slow': 'pulse 3s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                    }
                }
            }
        }
    </script>

    <style>
        body { background-color: #0B0F19; color: #f8fafc; overflow: hidden; }
        
        /* Map Container Full Screen */
        #map { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 0; }
        
        /* Glassmorphism Panels */
        .glass {
            background: rgba(21, 27, 43, 0.85);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border-top: 1px solid rgba(255, 255, 255, 0.08);
        }

        /* Custom Scrollbar */
        .scroller::-webkit-scrollbar { width: 4px; }
        .scroller::-webkit-scrollbar-thumb { background: #334155; border-radius: 4px; }

        /* Leaflet Customization */
        .leaflet-control-attribution { display: none !important; }
        
        /* Animations */
        .slide-up { animation: slideUp 0.4s cubic-bezier(0.16, 1, 0.3, 1) forwards; }
        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
    </style>
</head>
<body class="h-screen w-screen relative">

    <!-- 1. MAP BACKGROUND -->
    <div id="map"></div>

    <!-- 2. TOP HUD (Heads Up Display) -->
    <header class="absolute top-0 left-0 w-full z-20 p-4 bg-gradient-to-b from-black/80 to-transparent pointer-events-none">
        <div class="flex justify-between items-start">
            <div>
                <div class="flex items-center gap-2 pointer-events-auto">
                    <div class="bg-accent/20 p-2 rounded-lg backdrop-blur-md border border-accent/30">
                        <i class="fas fa-satellite-dish text-accent animate-pulse"></i>
                    </div>
                    <div>
                        <h1 class="font-bold text-white tracking-tight leading-none">GEOMOTION<span class="text-accent text-xs align-top">PRO</span></h1>
                        <p class="text-[10px] text-gray-400 font-mono mt-0.5" id="gps-status">INITIALIZING...</p>
                    </div>
                </div>
            </div>
            
            <!-- Tombol History -->
            <button onclick="toggleHistory()" class="pointer-events-auto bg-panel/80 p-3 rounded-full border border-white/10 hover:bg-panel transition shadow-lg backdrop-blur-md">
                <i class="fas fa-history text-gray-300"></i>
            </button>
        </div>
    </header>

    <!-- 3. MAIN DASHBOARD (Bottom Sheet) -->
    <div class="absolute bottom-0 left-0 w-full z-20 flex flex-col items-center">
        
        <!-- Stats Card (Floating) -->
        <div id="stats-panel" class="w-full max-w-lg glass rounded-t-3xl p-6 pb-8 shadow-2xl slide-up transition-transform duration-300 transform translate-y-0">
            
            <!-- Drag Handle -->
            <div class="w-12 h-1.5 bg-gray-600/50 rounded-full mx-auto mb-6"></div>

            <!-- Timer Besar -->
            <div class="text-center mb-6">
                <div id="timer-display" class="font-mono text-5xl font-bold text-white tracking-widest drop-shadow-[0_0_15px_rgba(255,255,255,0.3)]">
                    00:00:00
                </div>
                <div class="flex justify-center items-center gap-2 mt-2 text-xs text-gray-400 uppercase tracking-widest">
                    <span id="recording-dot" class="w-2 h-2 rounded-full bg-red-500 hidden animate-ping"></span>
                    <span id="status-text">Ready to Start</span>
                </div>
            </div>

            <!-- Grid Data Utama -->
            <div class="grid grid-cols-3 gap-4 mb-8">
                <!-- Jarak -->
                <div class="text-center">
                    <div class="text-gray-400 text-[10px] uppercase font-bold tracking-wider mb-1">Jarak (km)</div>
                    <div class="text-2xl font-bold text-white" id="dist-val">0.00</div>
                </div>
                <!-- Kecepatan -->
                <div class="text-center border-x border-white/10 px-2 relative">
                    <div class="text-accent text-[10px] uppercase font-bold tracking-wider mb-1">Speed (km/h)</div>
                    <div class="text-3xl font-bold text-accent" id="speed-val">0.0</div>
                    <!-- Speed Bar Indicator -->
                    <div class="h-1 w-full bg-gray-700 rounded-full mt-2 overflow-hidden">
                        <div id="speed-bar" class="h-full bg-accent transition-all duration-500 w-0"></div>
                    </div>
                </div>
                <!-- Pace (Menit/Km) -->
                <div class="text-center">
                    <div class="text-gray-400 text-[10px] uppercase font-bold tracking-wider mb-1">Pace</div>
                    <div class="text-2xl font-bold text-white" id="pace-val">--:--</div>
                </div>
            </div>

            <!-- Secondary Stats (Hidden by default, expandable) -->
            <div id="extra-stats" class="grid grid-cols-3 gap-2 mb-6 text-center text-xs text-gray-400 transition-all duration-300 opacity-50 hover:opacity-100">
                <div class="bg-black/20 p-2 rounded">
                    <i class="fas fa-shoe-prints mb-1 block"></i>
                    <span id="steps-val">0</span> Lngkh
                </div>
                <div class="bg-black/20 p-2 rounded">
                    <i class="fas fa-fire mb-1 block text-orange-500"></i>
                    <span id="cal-val">0</span> Kcal
                </div>
                <div class="bg-black/20 p-2 rounded">
                    <i class="fas fa-mountain mb-1 block text-purple-500"></i>
                    <span id="alt-val">0</span>m Alt
                </div>
            </div>

            <!-- Action Buttons -->
            <div class="flex gap-4">
                <button id="btn-start" onclick="toggleTracking()" class="flex-1 bg-gradient-to-r from-blue-600 to-blue-500 hover:from-blue-500 hover:to-blue-400 text-white font-bold py-4 rounded-2xl shadow-[0_0_20px_rgba(59,130,246,0.3)] transition-all active:scale-95 flex items-center justify-center gap-2 text-lg uppercase tracking-wide">
                    <i class="fas fa-play"></i> Mulai
                </button>
                
                <button id="btn-stop" onclick="finishTracking()" class="hidden flex-1 bg-gradient-to-r from-red-600 to-pink-600 text-white font-bold py-4 rounded-2xl shadow-[0_0_20px_rgba(239,68,68,0.3)] transition-all active:scale-95 items-center justify-center gap-2 text-lg uppercase tracking-wide">
                    <i class="fas fa-stop"></i> Selesai
                </button>
            </div>
        </div>
    </div>

    <!-- 4. HISTORY MODAL -->
    <div id="history-modal" class="fixed inset-0 bg-black/90 z-50 hidden opacity-0 transition-opacity duration-300 backdrop-blur-sm">
        <div class="absolute inset-x-0 bottom-0 top-10 bg-panel rounded-t-3xl overflow-hidden flex flex-col shadow-2xl border-t border-white/10">
            <div class="p-6 flex justify-between items-center border-b border-white/5 bg-black/20">
                <h2 class="text-xl font-bold text-white"><i class="fas fa-history text-accent mr-2"></i>Riwayat</h2>
                <button onclick="toggleHistory()" class="text-gray-400 hover:text-white"><i class="fas fa-times text-xl"></i></button>
            </div>
            <div class="flex-1 overflow-y-auto p-4 scroller" id="history-list">
                <!-- History Items injected here -->
                <div class="text-center text-gray-500 mt-10">Belum ada riwayat aktivitas.</div>
            </div>
            <div class="p-4 border-t border-white/5 bg-black/20">
                <button onclick="clearHistory()" class="w-full py-3 text-red-400 text-sm font-semibold hover:bg-red-900/20 rounded-xl transition">Hapus Semua Data</button>
            </div>
        </div>
    </div>

    <!-- 5. SUMMARY MODAL (Result) -->
    <div id="summary-modal" class="fixed inset-0 bg-black z-50 hidden flex-col overflow-y-auto">
        <div class="p-6">
            <div class="text-center my-8">
                <div class="inline-flex p-4 rounded-full bg-success/20 text-success mb-4 ring-2 ring-success/50">
                    <i class="fas fa-flag-checkered text-4xl"></i>
                </div>
                <h2 class="text-3xl font-bold text-white">Sesi Selesai!</h2>
                <p class="text-gray-400 text-sm mt-1" id="sum-date">Minggu, 12 Okt 2024</p>
            </div>

            <!-- Summary Stats -->
            <div class="grid grid-cols-2 gap-4 mb-6">
                <div class="bg-white/5 p-4 rounded-2xl border border-white/5">
                    <div class="text-xs text-gray-400 uppercase">Jarak Total</div>
                    <div class="text-2xl font-bold text-white mt-1" id="sum-dist">0.00 <span class="text-sm font-normal text-gray-500">km</span></div>
                </div>
                <div class="bg-white/5 p-4 rounded-2xl border border-white/5">
                    <div class="text-xs text-gray-400 uppercase">Durasi</div>
                    <div class="text-2xl font-bold text-white mt-1 font-mono" id="sum-time">00:00:00</div>
                </div>
                <div class="bg-white/5 p-4 rounded-2xl border border-white/5">
                    <div class="text-xs text-gray-400 uppercase">Avg Pace</div>
                    <div class="text-xl font-bold text-white mt-1" id="sum-pace">0'00" <span class="text-sm font-normal text-gray-500">/km</span></div>
                </div>
                <div class="bg-white/5 p-4 rounded-2xl border border-white/5">
                    <div class="text-xs text-gray-400 uppercase">Kalori</div>
                    <div class="text-xl font-bold text-orange-400 mt-1" id="sum-cals">0 <span class="text-sm font-normal text-gray-500">kcal</span></div>
                </div>
            </div>

            <!-- Chart Container -->
            <div class="bg-white/5 p-4 rounded-2xl border border-white/5 mb-6">
                <h3 class="text-xs font-bold text-gray-400 uppercase mb-4">Analisis Kecepatan & Elevasi</h3>
                <canvas id="activityChart" class="w-full h-48"></canvas>
            </div>

            <button onclick="closeSummary()" class="w-full bg-accent hover:bg-blue-600 text-white font-bold py-4 rounded-2xl shadow-lg transition mb-8">
                SIMPAN & TUTUP
            </button>
        </div>
    </div>

    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <script>
        // --- PWA SERVICE WORKER REGISTRATION (BARU) ---
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                // Pastikan file service-worker.js berada di folder yang sama
                navigator.serviceWorker.register('./service-worker.js')
                    .then(reg => console.log('Service Worker Registered! Scope:', reg.scope))
                    .catch(err => console.log('Service Worker Error:', err));
            });
        }

        // --- CONFIG & STATE ---
        let map, userMarker, polyline;
        let pathCoordinates = []; // Array [lat, lng]
        let speedHistory = []; // Untuk chart
        let elevationHistory = []; // Untuk chart
        
        let isTracking = false;
        let watchId = null;
        let startTime = null;
        let timerInterval = null;
        
        // Data Metrik
        let distance = 0; // meter
        let steps = 0;
        let lastLat = null, lastLon = null;
        let lastAlt = null;
        let maxAlt = -Infinity, minAlt = Infinity;
        let totalElevationGain = 0;
        
        // Pedometer
        let lastX=0, lastY=0, lastZ=0;
        let lastStepTime = 0;

        // UI Elements
        const elTimer = document.getElementById('timer-display');
        const elDist = document.getElementById('dist-val');
        const elSpeed = document.getElementById('speed-val');
        const elPace = document.getElementById('pace-val');
        const elSteps = document.getElementById('steps-val');
        const elAlt = document.getElementById('alt-val');
        const elCal = document.getElementById('cal-val');
        const elGpsStatus = document.getElementById('gps-status');
        const elStatusText = document.getElementById('status-text');
        const btnStart = document.getElementById('btn-start');
        const btnStop = document.getElementById('btn-stop');
        const recordingDot = document.getElementById('recording-dot');

        // --- 1. INITIALIZATION ---
        
        window.onload = function() {
            initMap();
            loadHistory(); // Load data from localStorage
            
            // Check permissions early
            if (typeof DeviceMotionEvent !== 'undefined' && typeof DeviceMotionEvent.requestPermission === 'function') {
                // iOS requires user interaction, handled in Start button
            }
        };

        function initMap() {
            // Default center (Indonesia general), will jump to user location
            map = L.map('map', { zoomControl: false }).setView([-6.200000, 106.816666], 13);
            
            // Tile Layer: CartoDB Dark Matter (Futuristic Look)
            L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
                attribution: '&copy; OpenStreetMap &copy; CARTO',
                subdomains: 'abcd',
                maxZoom: 19
            }).addTo(map);

            // Create empty polyline
            polyline = L.polyline([], {
                color: '#3b82f6', // Accent Blue
                weight: 5,
                opacity: 0.8,
                lineJoin: 'round'
            }).addTo(map);

            // Initial User Location (Single shot)
            navigator.geolocation.getCurrentPosition(
                (pos) => {
                    const { latitude, longitude } = pos.coords;
                    updateUserMarker(latitude, longitude);
                    map.setView([latitude, longitude], 16);
                    elGpsStatus.innerText = "GPS LOCKED - READY";
                    elGpsStatus.classList.add("text-success");
                },
                (err) => {
                    elGpsStatus.innerText = "GPS ERROR: " + err.message;
                    elGpsStatus.classList.add("text-red-500");
                },
                { enableHighAccuracy: true }
            );
        }

        function updateUserMarker(lat, lng) {
            if (!userMarker) {
                // Custom Pulse Icon
                const pulseIcon = L.divIcon({
                    className: 'custom-div-icon',
                    html: `<div class="relative flex h-6 w-6">
                              <span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-blue-400 opacity-75"></span>
                              <span class="relative inline-flex rounded-full h-6 w-6 bg-blue-500 border-2 border-white"></span>
                           </div>`,
                    iconSize: [24, 24],
                    iconAnchor: [12, 12]
                });
                userMarker = L.marker([lat, lng], { icon: pulseIcon }).addTo(map);
            } else {
                userMarker.setLatLng([lat, lng]);
            }
        }

        // --- 2. TRACKING LOGIC ---

        async function toggleTracking() {
            if (!isTracking) {
                // Request Motion Permission (iOS)
                if (typeof DeviceMotionEvent !== 'undefined' && typeof DeviceMotionEvent.requestPermission === 'function') {
                    try { await DeviceMotionEvent.requestPermission(); } catch(e){}
                }
                
                startSession();
            }
        }

        function startSession() {
            isTracking = true;
            startTime = Date.now();
            
            // Reset Data
            distance = 0; steps = 0; totalElevationGain = 0;
            pathCoordinates = []; speedHistory = []; elevationHistory = [];
            lastLat = null; lastLon = null;
            
            // Clean Map Line
            polyline.setLatLngs([]);
            
            // UI Update
            updateUIState(true);
            speak("Activity started. Let's go!");

            // Start Loops
            timerInterval = setInterval(updateTimer, 1000);
            
            // GPS Watch
            watchId = navigator.geolocation.watchPosition(
                handleGeoSuccess, 
                handleGeoError, 
                { enableHighAccuracy: true, maximumAge: 0, timeout: 5000 }
            );
            
            // Pedometer
            window.addEventListener('devicemotion', handleMotion);
        }

        function finishTracking() {
            if (!isTracking) return;
            
            // Stop Loops
            clearInterval(timerInterval);
            navigator.geolocation.clearWatch(watchId);
            window.removeEventListener('devicemotion', handleMotion);
            
            isTracking = false;
            updateUIState(false);
            
            speak("Activity finished. Great job.");
            
            // Show Summary
            showSummary();
        }

        function updateUIState(active) {
            if (active) {
                btnStart.classList.add('hidden');
                btnStop.classList.remove('hidden');
                btnStop.classList.add('flex');
                elStatusText.innerText = "RECORDING ACTIVITY";
                elStatusText.classList.add('text-accent', 'animate-pulse');
                recordingDot.classList.remove('hidden');
                // Slide stats panel down slightly to reveal map more? optional.
            } else {
                btnStart.classList.remove('hidden');
                btnStop.classList.add('hidden');
                btnStop.classList.remove('flex');
                elStatusText.innerText = "SESSION PAUSED";
                elStatusText.classList.remove('text-accent', 'animate-pulse');
                recordingDot.classList.add('hidden');
            }
        }

        // --- 3. SENSOR HANDLERS ---

        function handleGeoSuccess(pos) {
            const crd = pos.coords;
            const lat = crd.latitude;
            const lng = crd.longitude;
            const accuracy = crd.accuracy;
            
            if (accuracy > 30) return; // Filter bad signal

            // Update Map
            updateUserMarker(lat, lng);
            
            // Follow user logic
            map.panTo([lat, lng], { animate: true, duration: 1 });

            // Calculate Distance & Draw Path
            if (lastLat !== null) {
                const d = getDistanceFromLatLonInM(lastLat, lastLon, lat, lng);
                
                // Noise filter (move > 2 meters)
                if (d > 2) {
                    distance += d;
                    
                    // Add to path
                    pathCoordinates.push([lat, lng]);
                    polyline.setLatLngs(pathCoordinates);
                    
                    // Speed Calculation (GPS Speed preferred)
                    let speedKmh = 0;
                    if (crd.speed !== null && crd.speed >= 0) {
                        speedKmh = crd.speed * 3.6;
                    } else {
                        // Fallback calc
                        // (Not implemented for brevity, using GPS speed)
                    }
                    
                    // Update Speed Bar Visual
                    const speedPercent = Math.min((speedKmh / 20) * 100, 100); // 20km/h max bar
                    document.getElementById('speed-bar').style.width = `${speedPercent}%`;
                    
                    // Store History for Chart
                    if (pathCoordinates.length % 5 === 0) { // Sample every 5th point
                        speedHistory.push(speedKmh);
                        if (crd.altitude) elevationHistory.push(crd.altitude);
                    }
                    
                    // Voice Feedback every 1km
                    const distKm = distance / 1000;
                    if (Math.floor(distKm) > Math.floor((distance - d) / 1000)) {
                        speak(`Distance ${Math.floor(distKm)} kilometers.`);
                    }

                    // Update DOM
                    elDist.innerText = (distance / 1000).toFixed(2);
                    elSpeed.innerText = speedKmh.toFixed(1);
                    elPace.innerText = calculatePace(speedKmh);
                }
            }

            // Altitude Logic
            if (crd.altitude !== null) {
                const alt = crd.altitude;
                elAlt.innerText = Math.round(alt);
                
                if (lastAlt !== null) {
                    const diff = alt - lastAlt;
                    if (diff > 0.5) totalElevationGain += diff;
                }
                lastAlt = alt;
            }

            lastLat = lat;
            lastLon = lng;
            
            // Calorie Calc (approx)
            const kcal = (distance / 1000) * 75 * 1.036; // Assume 75kg
            elCal.innerText = Math.round(kcal);
        }

        function handleGeoError(err) {
            console.warn("GPS Error", err);
        }

        function handleMotion(event) {
            const acc = event.accelerationIncludingGravity;
            if(!acc) return;
            
            // Simple magnitude calculation
            const mag = Math.sqrt(acc.x*acc.x + acc.y*acc.y + acc.z*acc.z);
            
            // Threshold for step
            const now = Date.now();
            if (mag > 11 && (now - lastStepTime > 350)) {
                steps++;
                lastStepTime = now;
                elSteps.innerText = steps;
            }
        }

        function updateTimer() {
            const diff = Date.now() - startTime;
            const h = Math.floor(diff / 3600000);
            const m = Math.floor((diff % 3600000) / 60000);
            const s = Math.floor((diff % 60000) / 1000);
            elTimer.innerText = `${pad(h)}:${pad(m)}:${pad(s)}`;
        }

        // --- 4. DATA PROCESSING & UTILS ---

        function getDistanceFromLatLonInM(lat1, lon1, lat2, lon2) {
            const R = 6371e3; // metres
            const φ1 = lat1 * Math.PI/180;
            const φ2 = lat2 * Math.PI/180;
            const Δφ = (lat2-lat1) * Math.PI/180;
            const Δλ = (lon2-lon1) * Math.PI/180;
            const a = Math.sin(Δφ/2) * Math.sin(Δφ/2) +
                      Math.cos(φ1) * Math.cos(φ2) *
                      Math.sin(Δλ/2) * Math.sin(Δλ/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            return R * c;
        }

        function calculatePace(speedKmh) {
            if (speedKmh < 1) return "--:--";
            const paceMinPerKm = 60 / speedKmh;
            const pMin = Math.floor(paceMinPerKm);
            const pSec = Math.round((paceMinPerKm - pMin) * 60);
            return `${pMin}'${pad(pSec)}"`;
        }

        function pad(n) { return n < 10 ? '0'+n : n; }

        function speak(text) {
            if ('speechSynthesis' in window) {
                const utterance = new SpeechSynthesisUtterance(text);
                utterance.lang = 'en-US'; // Bahasa Inggris terdengar lebih natural untuk fitness
                utterance.rate = 1.1;
                window.speechSynthesis.speak(utterance);
            }
        }

        // --- 5. SUMMARY & HISTORY ---

        function showSummary() {
            const modal = document.getElementById('summary-modal');
            const dateOpts = { weekday: 'long', day: 'numeric', month: 'short', year: 'numeric' };
            
            // Isi Data Summary
            document.getElementById('sum-date').innerText = new Date().toLocaleDateString('id-ID', dateOpts);
            document.getElementById('sum-dist').innerHTML = (distance/1000).toFixed(2) + ' <span class="text-sm font-normal text-gray-500">km</span>';
            document.getElementById('sum-time').innerText = elTimer.innerText;
            document.getElementById('sum-cals').innerHTML = elCal.innerText + ' <span class="text-sm font-normal text-gray-500">kcal</span>';
            
            // Hitung Avg Pace Total
            const durationHours = (Date.now() - startTime) / 3600000;
            const totalAvgSpeed = (distance/1000) / durationHours;
            document.getElementById('sum-pace').innerHTML = calculatePace(totalAvgSpeed) + ' <span class="text-sm font-normal text-gray-500">/km</span>';

            // Show Modal
            modal.classList.remove('hidden');
            modal.classList.add('flex');
            
            // Render Chart JS
            renderChart();
            
            // Save to History
            saveActivity({
                date: new Date().toISOString(),
                dist: (distance/1000).toFixed(2),
                time: elTimer.innerText,
                kcal: elCal.innerText
            });
        }

        let myChart = null;
        function renderChart() {
            const ctx = document.getElementById('activityChart').getContext('2d');
            
            if (myChart) myChart.destroy();
            
            // Create simplistic labels (just counting points)
            const labels = speedHistory.map((_, i) => i);
            
            myChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Speed (km/h)',
                        data: speedHistory,
                        borderColor: '#3b82f6',
                        backgroundColor: 'rgba(59, 130, 246, 0.2)',
                        borderWidth: 2,
                        tension: 0.4,
                        fill: true,
                        pointRadius: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: {
                        x: { display: false },
                        y: { 
                            grid: { color: 'rgba(255,255,255,0.1)' },
                            ticks: { color: '#94a3b8' } 
                        }
                    }
                }
            });
        }

        function closeSummary() {
            document.getElementById('summary-modal').classList.add('hidden');
            document.getElementById('summary-modal').classList.remove('flex');
            // Reset UI timer
            elTimer.innerText = "00:00:00";
            elDist.innerText = "0.00";
            elSpeed.innerText = "0.0";
            document.getElementById('speed-bar').style.width = "0%";
        }

        // --- 6. LOCAL STORAGE HISTORY ---

        function saveActivity(data) {
            let history = JSON.parse(localStorage.getItem('geomotion_history')) || [];
            history.unshift(data); // Add to top
            if(history.length > 20) history.pop(); // Keep last 20
            localStorage.setItem('geomotion_history', JSON.stringify(history));
            loadHistory();
        }

        function loadHistory() {
            const history = JSON.parse(localStorage.getItem('geomotion_history')) || [];
            const container = document.getElementById('history-list');
            container.innerHTML = "";
            
            if (history.length === 0) {
                container.innerHTML = '<div class="text-center text-gray-500 mt-10 text-sm">Belum ada riwayat.</div>';
                return;
            }

            history.forEach(item => {
                const dateObj = new Date(item.date);
                const dateStr = dateObj.toLocaleDateString('id-ID', { day:'numeric', month:'short' });
                
                const el = document.createElement('div');
                el.className = "bg-white/5 p-4 rounded-xl mb-3 border border-white/5 flex justify-between items-center";
                el.innerHTML = `
                    <div>
                        <div class="text-white font-bold text-lg">${item.dist} km</div>
                        <div class="text-xs text-gray-400">${dateStr} • ${item.time}</div>
                    </div>
                    <div class="text-right">
                        <div class="text-orange-400 font-bold text-sm">${item.kcal} kcal</div>
                        <i class="fas fa-chevron-right text-gray-600 text-xs"></i>
                    </div>
                `;
                container.appendChild(el);
            });
        }

        function toggleHistory() {
            const modal = document.getElementById('history-modal');
            if (modal.classList.contains('hidden')) {
                modal.classList.remove('hidden');
                setTimeout(() => modal.classList.remove('opacity-0'), 10);
            } else {
                modal.classList.add('opacity-0');
                setTimeout(() => modal.classList.add('hidden'), 300);
            }
        }
        
        function clearHistory() {
            if(confirm("Hapus semua riwayat?")) {
                localStorage.removeItem('geomotion_history');
                loadHistory();
            }
        }

    </script>
</body>
</html>

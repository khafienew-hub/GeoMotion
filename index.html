<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>GeoMotion PRO</title>

    <!-- PWA Meta Tags -->
    <meta name="theme-color" content="#0B0F19">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="apple-touch-icon" href="https://cdn-icons-png.flaticon.com/512/2983/2983696.png">
    
    <!-- Link ke Manifest -->
    <link rel="manifest" href="./manifest.json">
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Leaflet CSS (Peta) -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&family=Inter:wght@300;400;600;800&display=swap" rel="stylesheet">

    <!-- Chart.js (Grafik) -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                        mono: ['JetBrains Mono', 'monospace'],
                    },
                    colors: {
                        dark: '#0B0F19',
                        panel: '#151b2b',
                        accent: '#3b82f6',
                        accentGlow: 'rgba(59, 130, 246, 0.5)',
                        success: '#10b981',
                        neon: '#2563eb', // Ganti ke Biru yang lebih gelap agar terlihat di OSM
                    },
                    animation: {
                        'pulse-slow': 'pulse 3s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                    }
                }
            }
        }
    </script>

    <style>
        body { background-color: #0B0F19; color: #f8fafc; overflow: hidden; }
        
        /* Map Container Full Screen - Fixed Z-Index */
        #map { 
            position: absolute; 
            top: 0; 
            left: 0; 
            width: 100%; 
            height: 100%; 
            z-index: 1; 
            background-color: #e5e5e5; /* Warna dasar terang saat loading tile */
        }
        
        /* Glassmorphism Panels */
        .glass {
            background: rgba(21, 27, 43, 0.9); /* Sedikit lebih gelap agar teks terbaca di atas peta terang */
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border-top: 1px solid rgba(255, 255, 255, 0.08);
        }

        /* Custom Scrollbar */
        .scroller::-webkit-scrollbar { width: 4px; }
        .scroller::-webkit-scrollbar-thumb { background: #334155; border-radius: 4px; }

        /* Leaflet Customization */
        .leaflet-control-attribution { display: none !important; }
        
        /* Animations */
        .slide-up { animation: slideUp 0.4s cubic-bezier(0.16, 1, 0.3, 1) forwards; }
        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }

        /* Optimasi GPU untuk elemen bergerak (Kecuali Map) */
        .hardware-accel {
            transform: translateZ(0);
            will-change: transform;
        }
    </style>
</head>
<body class="h-screen w-screen relative">

    <!-- 1. MAP BACKGROUND -->
    <div id="map"></div>

    <!-- 2. TOP HUD (Heads Up Display) -->
    <header class="absolute top-0 left-0 w-full z-20 p-4 bg-gradient-to-b from-black/60 to-transparent pointer-events-none">
        <div class="flex justify-between items-start">
            <div>
                <div class="flex items-center gap-2 pointer-events-auto">
                    <div class="bg-panel/90 p-2 rounded-lg backdrop-blur-md border border-white/10 shadow-lg">
                        <i class="fas fa-satellite-dish text-accent animate-pulse"></i>
                    </div>
                    <!-- Tambahkan background gelap tipis agar teks terbaca di peta terang -->
                    <div class="bg-panel/60 px-3 py-1 rounded-lg backdrop-blur-sm">
                        <h1 class="font-bold text-white tracking-tight leading-none">GEOMOTION<span class="text-accent text-xs align-top">PRO</span></h1>
                        <p class="text-[10px] text-gray-300 font-mono mt-0.5" id="gps-status">INITIALIZING...</p>
                    </div>
                </div>
            </div>
            
            <!-- Tombol History -->
            <button onclick="toggleHistory()" class="pointer-events-auto bg-panel/90 p-3 rounded-full border border-white/10 hover:bg-panel transition shadow-lg backdrop-blur-md text-white">
                <i class="fas fa-history"></i>
            </button>
        </div>
    </header>

    <!-- 3. MAIN DASHBOARD (Bottom Sheet) -->
    <div class="absolute bottom-0 left-0 w-full z-20 flex flex-col items-center">
        
        <!-- Stats Card (Floating) -->
        <!-- UPDATED: padding-bottom (pb-20) diperbesar agar tombol naik di Android -->
        <div id="stats-panel" class="w-full max-w-lg glass rounded-t-3xl p-6 pb-20 shadow-2xl slide-up transition-transform duration-300 transform translate-y-0">
            
            <!-- Drag Handle -->
            <div class="w-12 h-1.5 bg-gray-600/50 rounded-full mx-auto mb-6"></div>

            <!-- Timer Besar -->
            <div class="text-center mb-6">
                <div id="timer-display" class="font-mono text-5xl font-bold text-white tracking-widest drop-shadow-[0_2px_4px_rgba(0,0,0,0.8)]">
                    00:00:00
                </div>
                <div class="flex justify-center items-center gap-2 mt-2 text-xs text-gray-400 uppercase tracking-widest">
                    <span id="recording-dot" class="w-2 h-2 rounded-full bg-red-500 hidden animate-ping"></span>
                    <span id="status-text">Ready to Start</span>
                </div>
            </div>

            <!-- Grid Data Utama -->
            <div class="grid grid-cols-3 gap-4 mb-8">
                <!-- Jarak -->
                <div class="text-center">
                    <div class="text-gray-400 text-[10px] uppercase font-bold tracking-wider mb-1">Jarak (km)</div>
                    <div class="text-2xl font-bold text-white" id="dist-val">0.00</div>
                </div>
                <!-- Kecepatan -->
                <div class="text-center border-x border-white/10 px-2 relative">
                    <div class="text-accent text-[10px] uppercase font-bold tracking-wider mb-1">Speed (km/h)</div>
                    <div class="text-3xl font-bold text-accent" id="speed-val">0.0</div>
                    <!-- Speed Bar Indicator -->
                    <div class="h-1 w-full bg-gray-700 rounded-full mt-2 overflow-hidden">
                        <div id="speed-bar" class="h-full bg-accent transition-all duration-500 w-0 hardware-accel"></div>
                    </div>
                </div>
                <!-- Pace (Menit/Km) -->
                <div class="text-center">
                    <div class="text-gray-400 text-[10px] uppercase font-bold tracking-wider mb-1">Pace</div>
                    <div class="text-2xl font-bold text-white" id="pace-val">--:--</div>
                </div>
            </div>

            <!-- Secondary Stats -->
            <div id="extra-stats" class="grid grid-cols-3 gap-2 mb-6 text-center text-xs text-gray-400 transition-all duration-300 opacity-50 hover:opacity-100">
                <div class="bg-black/40 p-2 rounded border border-white/5">
                    <i class="fas fa-shoe-prints mb-1 block text-gray-300"></i>
                    <span id="steps-val">0</span> Lngkh
                </div>
                <div class="bg-black/40 p-2 rounded border border-white/5">
                    <i class="fas fa-fire mb-1 block text-orange-500"></i>
                    <span id="cal-val">0</span> Kcal
                </div>
                <div class="bg-black/40 p-2 rounded border border-white/5">
                    <i class="fas fa-mountain mb-1 block text-purple-500"></i>
                    <span id="alt-val">0</span>m Alt
                </div>
            </div>

            <!-- Action Buttons -->
            <div class="flex gap-4">
                <button id="btn-start" onclick="toggleTracking()" class="flex-1 bg-gradient-to-r from-blue-600 to-blue-500 hover:from-blue-500 hover:to-blue-400 text-white font-bold py-4 rounded-2xl shadow-[0_0_20px_rgba(59,130,246,0.3)] transition-all active:scale-95 flex items-center justify-center gap-2 text-lg uppercase tracking-wide">
                    <i class="fas fa-play"></i> Mulai
                </button>
                
                <button id="btn-stop" onclick="finishTracking()" class="hidden flex-1 bg-gradient-to-r from-red-600 to-pink-600 text-white font-bold py-4 rounded-2xl shadow-[0_0_20px_rgba(239,68,68,0.3)] transition-all active:scale-95 items-center justify-center gap-2 text-lg uppercase tracking-wide">
                    <i class="fas fa-stop"></i> Selesai
                </button>
            </div>
        </div>
    </div>

    <!-- 4. HISTORY MODAL -->
    <div id="history-modal" class="fixed inset-0 bg-black/90 z-50 hidden opacity-0 transition-opacity duration-300 backdrop-blur-sm">
        <div class="absolute inset-x-0 bottom-0 top-10 bg-panel rounded-t-3xl overflow-hidden flex flex-col shadow-2xl border-t border-white/10">
            <div class="p-6 flex justify-between items-center border-b border-white/5 bg-black/20">
                <h2 class="text-xl font-bold text-white"><i class="fas fa-history text-accent mr-2"></i>Riwayat</h2>
                <button onclick="toggleHistory()" class="text-gray-400 hover:text-white"><i class="fas fa-times text-xl"></i></button>
            </div>
            <div class="flex-1 overflow-y-auto p-4 scroller" id="history-list">
                <div class="text-center text-gray-500 mt-10">Belum ada riwayat aktivitas.</div>
            </div>
            <div class="p-4 border-t border-white/5 bg-black/20">
                <button onclick="clearHistory()" class="w-full py-3 text-red-400 text-sm font-semibold hover:bg-red-900/20 rounded-xl transition">Hapus Semua Data</button>
            </div>
        </div>
    </div>

    <!-- 5. SUMMARY MODAL (Result) -->
    <div id="summary-modal" class="fixed inset-0 bg-black z-50 hidden flex-col overflow-y-auto">
        <div class="p-6">
            <div class="text-center mt-8 mb-4">
                <div class="inline-flex p-4 rounded-full bg-success/20 text-success mb-4 ring-2 ring-success/50">
                    <i class="fas fa-flag-checkered text-4xl"></i>
                </div>
                <h2 class="text-3xl font-bold text-white">Sesi Selesai!</h2>
                <p class="text-gray-400 text-sm mt-1" id="sum-date">...</p>
            </div>

            <!-- UPDATED: Tombol Simpan dipindahkan ke ATAS -->
            <button onclick="closeSummary()" class="w-full bg-accent hover:bg-blue-600 text-white font-bold py-3 rounded-2xl shadow-lg transition mb-6 flex items-center justify-center gap-2">
                <i class="fas fa-check"></i> SIMPAN & TUTUP
            </button>

            <div class="grid grid-cols-2 gap-4 mb-6">
                <div class="bg-white/5 p-4 rounded-2xl border border-white/5">
                    <div class="text-xs text-gray-400 uppercase">Jarak Total</div>
                    <div class="text-2xl font-bold text-white mt-1" id="sum-dist">0.00 <span class="text-sm font-normal text-gray-500">km</span></div>
                </div>
                <div class="bg-white/5 p-4 rounded-2xl border border-white/5">
                    <div class="text-xs text-gray-400 uppercase">Durasi</div>
                    <div class="text-2xl font-bold text-white mt-1 font-mono" id="sum-time">00:00:00</div>
                </div>
                <div class="bg-white/5 p-4 rounded-2xl border border-white/5">
                    <div class="text-xs text-gray-400 uppercase">Avg Pace</div>
                    <div class="text-xl font-bold text-white mt-1" id="sum-pace">-- <span class="text-sm font-normal text-gray-500">/km</span></div>
                </div>
                <div class="bg-white/5 p-4 rounded-2xl border border-white/5">
                    <div class="text-xs text-gray-400 uppercase">Kalori</div>
                    <div class="text-xl font-bold text-orange-400 mt-1" id="sum-cals">0 <span class="text-sm font-normal text-gray-500">kcal</span></div>
                </div>
            </div>

            <div class="bg-white/5 p-4 rounded-2xl border border-white/5 mb-8">
                <h3 class="text-xs font-bold text-gray-400 uppercase mb-4">Analisis Kecepatan & Elevasi</h3>
                <canvas id="activityChart" class="w-full h-48"></canvas>
            </div>

            <!-- Tombol lama di bawah dihapus -->
        </div>
    </div>

    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <script>
        // --- PWA REGISTRATION ---
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('./service-worker.js')
                    .catch(err => console.log('SW Fail:', err));
            });
        }

        // --- CONFIG & STATE ---
        let map, userMarker, polyline;
        let pathCoordinates = [];
        let speedHistory = [];
        
        let isTracking = false;
        let watchId = null;
        let startTime = null;
        let timerInterval = null;
        
        // Optimasi: Variabel Throttling
        let lastUIUpdate = 0; 
        const UI_UPDATE_INTERVAL = 1500; // Update peta/UI tiap 1.5 detik agar ringan
        
        let distance = 0;
        let steps = 0;
        let lastLat = null, lastLon = null;
        let lastAlt = null;
        let totalElevationGain = 0;
        
        let lastStepTime = 0;

        // UI Elements
        const elTimer = document.getElementById('timer-display');
        const elDist = document.getElementById('dist-val');
        const elSpeed = document.getElementById('speed-val');
        const elPace = document.getElementById('pace-val');
        const elSteps = document.getElementById('steps-val');
        const elAlt = document.getElementById('alt-val');
        const elCal = document.getElementById('cal-val');
        const elGpsStatus = document.getElementById('gps-status');
        const elStatusText = document.getElementById('status-text');
        const btnStart = document.getElementById('btn-start');
        const btnStop = document.getElementById('btn-stop');
        const recordingDot = document.getElementById('recording-dot');

        // --- INITIALIZATION ---
        
        window.onload = function() {
            initMap();
            loadHistory();
        };

        function initMap() {
            map = L.map('map', { 
                zoomControl: false, 
                attributionControl: false 
            }).setView([-6.200, 106.816], 13);
            
            // Tile Layer (OpenStreetMap Standard) - Lebih Terang
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                maxZoom: 19,
                attribution: '&copy; OpenStreetMap contributors'
            }).addTo(map);

            // GARIS RUTE (POLYLINE)
            // Ganti warna ke Biru Tua (#2563eb) agar kontras dengan peta terang
            polyline = L.polyline([], {
                color: '#2563eb', 
                weight: 6,
                opacity: 0.9,
                lineJoin: 'round',
                className: 'drop-shadow-md'
            }).addTo(map);

            // Invalidate size setelah init untuk memastikan rendering full
            setTimeout(() => { map.invalidateSize(); }, 500);

            // Get initial pos without watch to save battery initially
            navigator.geolocation.getCurrentPosition(
                (pos) => {
                    const { latitude, longitude } = pos.coords;
                    updateUserMarker(latitude, longitude);
                    map.setView([latitude, longitude], 16);
                    elGpsStatus.innerText = "GPS READY";
                    elGpsStatus.classList.add("text-success");
                },
                (err) => {
                    elGpsStatus.innerText = "GPS ERROR";
                    elGpsStatus.classList.add("text-red-500");
                },
                { enableHighAccuracy: true }
            );
        }

        function updateUserMarker(lat, lng) {
            if (!userMarker) {
                // Marker juga disesuaikan agar terlihat di peta terang
                const pulseIcon = L.divIcon({
                    className: 'custom-div-icon',
                    html: `<div class="relative flex h-6 w-6">
                              <span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-blue-500 opacity-75"></span>
                              <span class="relative inline-flex rounded-full h-6 w-6 bg-blue-600 border-2 border-white shadow-lg"></span>
                           </div>`,
                    iconSize: [24, 24], iconAnchor: [12, 12]
                });
                userMarker = L.marker([lat, lng], { icon: pulseIcon }).addTo(map);
            } else {
                userMarker.setLatLng([lat, lng]);
            }
        }

        // --- TRACKING LOGIC ---

        async function toggleTracking() {
            if (!isTracking) {
                if (typeof DeviceMotionEvent !== 'undefined' && typeof DeviceMotionEvent.requestPermission === 'function') {
                    try { await DeviceMotionEvent.requestPermission(); } catch(e){}
                }
                startSession();
            }
        }

        function startSession() {
            isTracking = true;
            startTime = Date.now();
            
            // Reset
            distance = 0; steps = 0; totalElevationGain = 0;
            pathCoordinates = []; speedHistory = [];
            lastLat = null; lastLon = null; lastUIUpdate = 0;
            
            polyline.setLatLngs([]);
            updateUIState(true);
            speak("Started");

            timerInterval = setInterval(updateTimer, 1000);
            
            // GPS Watch
            watchId = navigator.geolocation.watchPosition(
                handleGeoSuccess, handleGeoError, 
                { enableHighAccuracy: true, maximumAge: 0 }
            );
            
            window.addEventListener('devicemotion', handleMotion);
        }

        function finishTracking() {
            if (!isTracking) return;
            
            clearInterval(timerInterval);
            navigator.geolocation.clearWatch(watchId);
            window.removeEventListener('devicemotion', handleMotion);
            
            isTracking = false;
            updateUIState(false);
            speak("Finished");
            showSummary();
        }

        function updateUIState(active) {
            if (active) {
                btnStart.classList.add('hidden');
                btnStop.classList.remove('hidden');
                btnStop.classList.add('flex');
                elStatusText.innerText = "RECORDING";
                elStatusText.classList.add('text-accent', 'animate-pulse');
                recordingDot.classList.remove('hidden');
            } else {
                btnStart.classList.remove('hidden');
                btnStop.classList.add('hidden');
                btnStop.classList.remove('flex');
                elStatusText.innerText = "PAUSED";
                elStatusText.classList.remove('text-accent', 'animate-pulse');
                recordingDot.classList.add('hidden');
            }
        }

        // --- OPTIMIZED SENSOR HANDLERS ---

        function handleGeoSuccess(pos) {
            const crd = pos.coords;
            const lat = crd.latitude;
            const lng = crd.longitude;
            
            // 1. DATA PROCESSING (Always run for accuracy)
            if (crd.accuracy > 40) return; // Ignore bad GPS

            // Logic Rute: Selalu tambah titik awal jika array kosong
            if (pathCoordinates.length === 0) {
                 pathCoordinates.push([lat, lng]);
            }

            if (lastLat !== null) {
                const d = getDistanceFromLatLonInM(lastLat, lastLon, lat, lng);
                if (d > 2) { // Only count if moved > 2m
                    distance += d;
                    pathCoordinates.push([lat, lng]);
                    
                    let speedKmh = (crd.speed || 0) * 3.6;
                    
                    // Voice Coach (Every 1km)
                    const distKm = distance / 1000;
                    if (Math.floor(distKm) > Math.floor((distance - d) / 1000)) {
                        speak(`Distance ${Math.floor(distKm)} km`);
                    }

                    // Save history occasionally to save memory
                    if (pathCoordinates.length % 5 === 0) speedHistory.push(speedKmh);
                }
            }
            
            if (crd.altitude !== null) {
                 // Simple altitude logic
                 if(lastAlt !== null && (crd.altitude - lastAlt > 0.5)) {
                     totalElevationGain += (crd.altitude - lastAlt);
                 }
                 lastAlt = crd.altitude;
            }

            lastLat = lat;
            lastLon = lng;

            // 2. VISUAL UPDATES (Throttled for Performance)
            // Hanya update peta dan text UI jika interval waktu tercapai
            const now = Date.now();
            if (now - lastUIUpdate > UI_UPDATE_INTERVAL) {
                requestAnimationFrame(() => {
                    // Update Map
                    updateUserMarker(lat, lng);
                    map.panTo([lat, lng], { animate: true, duration: 1.0 }); // Smooth pan
                    
                    // Update GARIS PETA
                    if (pathCoordinates.length > 0) {
                         polyline.setLatLngs(pathCoordinates);
                    }
                    
                    // Update Texts
                    const speedKmh = (crd.speed || 0) * 3.6;
                    elDist.innerText = (distance / 1000).toFixed(2);
                    elSpeed.innerText = speedKmh.toFixed(1);
                    elPace.innerText = calculatePace(speedKmh);
                    elAlt.innerText = Math.round(lastAlt || 0);
                    
                    // Update Bar
                    const speedPercent = Math.min((speedKmh / 20) * 100, 100);
                    document.getElementById('speed-bar').style.width = `${speedPercent}%`;
                    
                    // Update Calories
                    const kcal = (distance / 1000) * 75 * 1.036;
                    elCal.innerText = Math.round(kcal);
                });
                
                lastUIUpdate = now;
            }
        }

        function handleGeoError(err) { /* Silently fail or log */ }

        function handleMotion(event) {
            // Throttling logic is implicitly handled by step threshold
            const acc = event.accelerationIncludingGravity;
            if(!acc) return;
            
            const mag = Math.sqrt(acc.x*acc.x + acc.y*acc.y + acc.z*acc.z);
            const now = Date.now();
            
            if (mag > 11 && (now - lastStepTime > 350)) {
                steps++;
                lastStepTime = now;
                // Update DOM directly here is fine as steps are infrequent
                elSteps.innerText = steps;
            }
        }

        function updateTimer() {
            const diff = Date.now() - startTime;
            const h = Math.floor(diff / 3600000);
            const m = Math.floor((diff % 3600000) / 60000);
            const s = Math.floor((diff % 60000) / 1000);
            elTimer.innerText = `${pad(h)}:${pad(m)}:${pad(s)}`;
        }

        // --- UTILS ---

        function getDistanceFromLatLonInM(lat1, lon1, lat2, lon2) {
            const R = 6371e3;
            const dLat = deg2rad(lat2-lat1);
            const dLon = deg2rad(lon2-lon1); 
            const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                      Math.cos(deg2rad(lat1)) * Math.cos(deg2rad(lat2)) * Math.sin(dLon/2) * Math.sin(dLon/2); 
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a)); 
            return R * c;
        }

        function deg2rad(deg) { return deg * (Math.PI/180); }

        function calculatePace(speedKmh) {
            if (speedKmh < 1) return "--:--";
            const paceMinPerKm = 60 / speedKmh;
            const pMin = Math.floor(paceMinPerKm);
            const pSec = Math.round((paceMinPerKm - pMin) * 60);
            return `${pMin}'${pad(pSec)}"`;
        }

        function pad(n) { return n < 10 ? '0'+n : n; }

        function speak(text) {
            if ('speechSynthesis' in window) {
                const u = new SpeechSynthesisUtterance(text);
                u.lang = 'en-US'; u.rate = 1.1;
                window.speechSynthesis.speak(u);
            }
        }

        // --- SUMMARY & HISTORY ---

        function showSummary() {
            const modal = document.getElementById('summary-modal');
            const dateOpts = { weekday: 'long', day: 'numeric', month: 'short' };
            
            document.getElementById('sum-date').innerText = new Date().toLocaleDateString('id-ID', dateOpts);
            document.getElementById('sum-dist').innerHTML = (distance/1000).toFixed(2) + ' <span class="text-sm font-normal text-gray-500">km</span>';
            document.getElementById('sum-time').innerText = elTimer.innerText;
            document.getElementById('sum-cals').innerHTML = elCal.innerText + ' <span class="text-sm font-normal text-gray-500">kcal</span>';
            
            const durationHours = (Date.now() - startTime) / 3600000;
            const totalAvgSpeed = (distance/1000) / (durationHours || 1);
            document.getElementById('sum-pace').innerHTML = calculatePace(totalAvgSpeed) + ' <span class="text-sm font-normal text-gray-500">/km</span>';

            modal.classList.remove('hidden');
            modal.classList.add('flex');
            renderChart();
            saveActivity({
                date: new Date().toISOString(),
                dist: (distance/1000).toFixed(2),
                time: elTimer.innerText,
                kcal: elCal.innerText
            });
        }

        let myChart = null;
        function renderChart() {
            const ctx = document.getElementById('activityChart').getContext('2d');
            if (myChart) myChart.destroy();
            const labels = speedHistory.map((_, i) => i);
            myChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Speed', data: speedHistory,
                        borderColor: '#3b82f6', backgroundColor: 'rgba(59, 130, 246, 0.2)',
                        borderWidth: 2, tension: 0.4, fill: true, pointRadius: 0
                    }]
                },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: { x: { display: false }, y: { grid: { color: 'rgba(255,255,255,0.1)' }, ticks: { color: '#94a3b8' } } }
                }
            });
        }

        function closeSummary() {
            document.getElementById('summary-modal').classList.add('hidden');
            document.getElementById('summary-modal').classList.remove('flex');
            elTimer.innerText = "00:00:00"; elDist.innerText = "0.00"; elSpeed.innerText = "0.0";
            document.getElementById('speed-bar').style.width = "0%";
        }

        function saveActivity(data) {
            let history = JSON.parse(localStorage.getItem('geomotion_history')) || [];
            history.unshift(data); if(history.length > 20) history.pop();
            localStorage.setItem('geomotion_history', JSON.stringify(history));
            loadHistory();
        }

        function loadHistory() {
            const history = JSON.parse(localStorage.getItem('geomotion_history')) || [];
            const container = document.getElementById('history-list');
            container.innerHTML = "";
            if (history.length === 0) {
                container.innerHTML = '<div class="text-center text-gray-500 mt-10 text-sm">Belum ada riwayat.</div>';
                return;
            }
            history.forEach(item => {
                const dateObj = new Date(item.date);
                const dateStr = dateObj.toLocaleDateString('id-ID', { day:'numeric', month:'short' });
                const el = document.createElement('div');
                el.className = "bg-white/5 p-4 rounded-xl mb-3 border border-white/5 flex justify-between items-center";
                el.innerHTML = `
                    <div><div class="text-white font-bold text-lg">${item.dist} km</div><div class="text-xs text-gray-400">${dateStr} â€¢ ${item.time}</div></div>
                    <div class="text-right"><div class="text-orange-400 font-bold text-sm">${item.kcal} kcal</div></div>`;
                container.appendChild(el);
            });
        }

        function toggleHistory() {
            const modal = document.getElementById('history-modal');
            if (modal.classList.contains('hidden')) {
                modal.classList.remove('hidden'); setTimeout(() => modal.classList.remove('opacity-0'), 10);
            } else {
                modal.classList.add('opacity-0'); setTimeout(() => modal.classList.add('hidden'), 300);
            }
        }
        
        function clearHistory() {
            if(confirm("Hapus semua riwayat?")) {
                localStorage.removeItem('geomotion_history'); loadHistory();
            }
        }
    </script>
</body>
</html>
